<html>
  <script src="//www.WEBRTC-Experiment.com/RecordRTC.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<body>
  <script>
    var audioRecorder;

    function gotStream(audioStream) {
      audioRecorder = RecordRTC(audioStream, {
        recorderType: StereoAudioRecorder,
        numberOfAudioChannels: 1
      });
    }

    function initAudio() {
      if (!navigator.getUserMedia)
          navigator.getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
      if (!navigator.cancelAnimationFrame)
          navigator.cancelAnimationFrame = navigator.webkitCancelAnimationFrame || navigator.mozCancelAnimationFrame;
      if (!navigator.requestAnimationFrame)
          navigator.requestAnimationFrame = navigator.webkitRequestAnimationFrame || navigator.mozRequestAnimationFrame;

      navigator.getUserMedia({
        "audio": {
          "mandatory": {
              "googEchoCancellation": "false",
              "googAutoGainControl": "false",
              "googNoiseSuppression": "false",
              "googHighpassFilter": "false"
          },
          "optional": []
        },
      }, gotStream, function(e) {
        alert('Error getting audio');
        console.log(e);
      });
    }

    function downloadResult(blob) {
      var url = (window.URL || window.webkitURL).createObjectURL(blob);
      var link = document.getElementById("save");
      link.download="file.flac";
      link.href = url;
      link.click();
    }

    function transmitResult(blob) {
      console.log("transmitting", blob);
      sendBlobToSpeech(blob, 'flac', 8000);
    }

    function transmitRecording() {
      var f = audioRecorder.blob;
      f.name = 'file.wav';

      // TODO: Why does this not work?
      //sendBlobToSpeech(f, 'MULAW', 8000);

      convertToFlac(f, transmitResult);
    }

    function saveRecording() {
        var f = audioRecorder.blob;
        f.name = 'file.wav';
        convertToFlac(f, downloadResult);
    }

    function sendBlobToSpeech(blob, encoding, rate) {
      var speechSender = new FileReader();
      speechSender.addEventListener('loadend', function() {
        gapi.client.speech.speech.syncrecognize({
            config: {
              encoding: encoding,
              sampleRate: rate
            },
            audio : {
              content: btoa(speechSender.result)
            }
          }).execute(function(r){
            console.log(r);
          });
      });
      speechSender.readAsBinaryString(blob);
    }

    function convertToFlac(f, callback) {
      worker = new Worker('/flac.js/worker/EmsWorkerProxy.js');
      // Listen for messages by the worker
      worker.onmessage = function(e) {
        if (e.data && e.data.reply === 'done') {
          for (fileName in e.data.values) {
            // Pass the flac blob to the callback
            callback(e.data.values[fileName].blob);
          }
        }
      };

      fr = new FileReader();
      fr.addEventListener('loadend', function() {
        var encodedName = "file.wav";

        var args = [
          encodedName
        ];
        console.log(args);
        var inData = {};
        inData[f.name] = new Uint8Array(fr.result);

        var outData = {};
        outData['file.flac'] = {
          // Its MIME type
          'MIME': 'audio/flac'
        };

        // Finally post all the data to the
        // worker together with the "encode"
        // command.
        worker.postMessage({
          command: 'encode',
          args: args,
          outData: outData,
          fileData: inData
        });
      });

      fr.readAsArrayBuffer(f);
    }


  </script>

  <button onclick="audioRecorder.startRecording()">Start Recording</button>
  <button onclick="audioRecorder.stopRecording()">Stop Recording</button>
  <button onclick="transmitRecording()">Transmit Recording</button>
  <button onclick="saveRecording()">Save Recording</button>
  <a href="#save" id="save">Save</a>

  <a style="display:none" id="save" href="">Save</a>

  <script>
    function initGapi(){
      console.log('loading gapi');

      var xhr = new XMLHttpRequest();
      xhr.overrideMimeType("application/json");
      xhr.open('GET', 'config.json', true);
      xhr.onreadystatechane = function () {
        if (xhr.readyState == 4 && xhr.status == "200") {
          console.log(xhr.responseText);
          console.log(xhr.responseText.apiKey);
          var json = JSON.parse(xhr.responseText);
          gapi.client.setApiKey(json.apiKey);
        }
      };
      xhr.send(null);

      gapi.client.load('speech', 'v1beta1');
    }
    initAudio();
  </script>
  <script src="https://apis.google.com/js/client:api.js?onload=initGapi"></script>
</body>
</html>
